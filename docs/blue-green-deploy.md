# Blue/Greenデプロイメント手順

## 前提条件
- ネットワーク、ECR、Blue/Green ECSサービスが構築済み
- ソースコードの変更が完了済み

## デプロイ手順

### ユースケース別デプロイ手順

| ユースケース | 対象者 | 手順 | コマンド | 所要時間 |
|-------------|--------|------|----------|----------|
| **ソース修正後デプロイ** | 開発者 | 1. ソース修正<br>2. 統合デプロイ実行 | `vim index.html`<br>`./scripts/dev-deploy.sh v2.0.0` | 約7分 |
| **既存イメージでデプロイ** | 運用者 | 1. デプロイのみ実行 | `./scripts/deploy.sh v2.0.0` | 約5分 |
| **自動デプロイ** | CI/CD | 1. タグプッシュ | `git tag v2.0.0`<br>`git push origin v2.0.0` | 約7分 |
| **ビルドのみ** | 開発者 | 1. イメージ作成のみ | `./scripts/build.sh v2.0.0` | 約2分 |

### 検証・テスト手順

| 検証タイプ | 目的 | コマンド | 実行タイミング |
|-----------|------|----------|----------------|
| **事前検証** | 前提条件・リソース状態確認 | `./test/verify.sh` | デプロイ前 |
| **統合テスト** | 実際のデプロイ動作テスト | `./test/test-deploy.sh` | 開発時 |

### 監視・運用手順

| 操作 | 目的 | コマンド | 使用場面 |
|------|------|----------|----------|
| **デプロイ状況確認** | 進行状況監視 | `aws deploy get-deployment --deployment-id <ID>` | デプロイ中 |
| **ECSサービス確認** | サービス状態確認 | `aws ecs describe-services --cluster ecs-bg-deploy-cluster --services ecs-bg-deploy-service` | 運用時 |
| **手動ロールバック** | 緊急時復旧 | `aws deploy stop-deployment --deployment-id <ID> --auto-rollback-enabled` | 障害時 |

## 重要事項

| 項目 | 内容 | 影響 |
|------|------|------|
| **リソース使用量** | デプロイ中は一時的に2倍 | コスト増加（約5分間） |
| **Blue環境** | 成功後5分で自動終了 | 自動クリーンアップ |
| **失敗時対応** | 自動ロールバック実行 | サービス継続性確保 |
| **デプロイ時間** | 約5-7分 | サービス無停止 |
| **検証済み** | 統合テスト成功確認済み | 実運用可能 |
